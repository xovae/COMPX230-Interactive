@using System.Text.RegularExpressions
@inject IJSRuntime JSRuntime

@code {
    [Parameter]
    public EventCallback<(string, string[], List<string>)> Exported { get; set; }

    [Parameter]
    required public string Toolbox { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initBlockly", Toolbox);
            await JSRuntime.InvokeVoidAsync("initUpdate");
            StateHasChanged();
        }
    }

    public async Task Export()
    {
        string code = await JSRuntime.InvokeAsync<string>("generateCode");
        await JSRuntime.InvokeVoidAsync("updateCode", "Compile");
        string highlightBlockPattern = @"highlightBlock\('([^']+)'\)\n\t";

        if (code.Contains("main:") && code.Contains(".global main") && code.Contains(".text"))
        {
            if (!code.Contains("$_"))
            {
                //Remove highlightBlock() from any lines that aren't WRAMP instructions
                code = Regex.Replace(code, highlightBlockPattern + @"\.text", ".text");
                code = Regex.Replace(code, highlightBlockPattern + @"\.data", ".data");
                code = Regex.Replace(code, highlightBlockPattern + @"\.bss", ".bss");
                code = Regex.Replace(code, highlightBlockPattern + @"\.global main", ".global main");

                //Removes highlightBlock() from labels
                code = Regex.Replace(code, highlightBlockPattern + @"LABEL([a-zA-Z0-9_.]+):", "$2:");

                //Extracts the ID of each block that can be executed in WRAMP for highlighting them in the Blockly workspace
                string[] highlightStatements = Regex.Matches(code, highlightBlockPattern).Cast<Match>().Select(m => m.Groups[1].Value.Trim()).ToArray();
                code = Regex.Replace(code, highlightBlockPattern, String.Empty);

                //Get every label name and position for display in WSIM
                string[] lines = code.Split(Environment.NewLine);
                List<string> labels = new List<string>();
                for (int i = 0; i < lines.Length; i++)
                {
                    if (!Regex.IsMatch(lines[i], @"^([a-zA-Z0-9_.]+):$"))
                    {
                        if (lines[i] != ".text" && lines[i] != ".data" && lines[i] != ".bss" && lines[i] != ".global main")
                        {
                            labels.Add("");
                        }
                    }
                    else
                    {
                        //Remove the previous whitespace entry (if it exists) to make the position of the label match up with it's proceeding instruction
                        if (labels.Count > 1) labels.RemoveAt(labels.Count - 1);
                        labels.Add(Regex.Replace(lines[i], @"^([a-zA-Z0-9_.]+):$", "$1"));
                    }
                }
                await Exported.InvokeAsync((code, highlightStatements, labels));
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Declare all registers!");
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "You must declare a .text segment with global main, and a label for main!");
        }
    }
}
